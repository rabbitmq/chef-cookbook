%%%
%% Generated by Chef
%%%

[
  {kernel, [
<%= @kernel %>
  ]},
<% if node['rabbitmq']['web_console_ssl'] -%>
  {rabbitmq_management, [
<% if node['rabbitmq']['management']['load_definitions'] %>
    {load_definitions, "<%= node['rabbitmq']['management']['definitions_file'] %>"},
<% end -%>
    {listener, [{port, <%= node['rabbitmq']['web_console_ssl_port'] %>},
<% if node['rabbitmq']['web_console_interface'] -%>
                {ip, "<%= node['rabbitmq']['web_console_interface'] %>"},
<% end -%>
                {ssl, true},
                {ssl_opts, [{cacertfile,"<%= node['rabbitmq']['ssl_cacert'] %>"},
                    {certfile,"<%= node['rabbitmq']['ssl_cert'] %>"},
                    {keyfile,"<%= node['rabbitmq']['ssl_key'] %>"}
                    <% if @ssl_versions -%>,{versions,[<%= @ssl_versions %>]}<% end -%>
                    <% if @ssl_ciphers -%>,{ciphers,[<%= @ssl_ciphers %>]}<% end -%>
                    ]}
              ]}
  ]},
<% else %>
  {rabbitmq_management, [
<% if node['rabbitmq']['management']['load_definitions'] %>
    {load_definitions, "<%= node['rabbitmq']['management']['definitions_file'] %>"},
<% end -%>
    {listener, [
                {port, <%= node['rabbitmq']['web_console_port'] %>}
<% if node['rabbitmq']['web_console_interface'] -%>
                ,{ip, "<%= node['rabbitmq']['web_console_interface'] %>"}
<% end -%>
    ]}
  ]},
<% end %>
<% if node['rabbitmq']['ssl'] && @ssl_versions -%>
  {ssl, [{versions, [<%= @ssl_versions %>]}]},
<% end %>
  {rabbit, [
    {auth_backends, [<%= node['rabbitmq']['auth_backends'] %>]},
<% if node['rabbitmq']['clustering']['enable'] -%>
    <%if node['rabbitmq']['clustering']['use_auto_clustering'] -%>
    {cluster_nodes, {[<%= node['rabbitmq']['clustering']['cluster_nodes'].map { |n| "'#{n['name']}'"}.join(',') %>], disc}},
    <% end %>
    {cluster_partition_handling,<%= node['rabbitmq']['clustering']['cluster_partition_handling'] %>},
<% end %>
<% if node['rabbitmq']['ssl'] -%>
    <% if node['rabbitmq']['ssl_listen_interface'] %>
    {ssl_listeners, [{"<%= node['rabbitmq']['ssl_listen_interface'] %>", <%= node['rabbitmq']['ssl_port'] %>}]},
    <% else %>
    {ssl_listeners, [<%= node['rabbitmq']['ssl_port'] %>]},
    <% end %>
    {ssl_options, [{cacertfile,"<%= node['rabbitmq']['ssl_cacert'] %>"},
                    {certfile,"<%= node['rabbitmq']['ssl_cert'] %>"},
                    {keyfile,"<%= node['rabbitmq']['ssl_key'] %>"},
                    {verify,<%= node['rabbitmq']['ssl_verify'] %>},
                    {fail_if_no_peer_cert,<%= node['rabbitmq']['ssl_fail_if_no_peer_cert'] %>}
                    <% if @ssl_versions -%>,{versions,[<%= @ssl_versions %>]}<% end -%>
                    <% if @ssl_ciphers -%>,{ciphers,[<%= @ssl_ciphers %>]}<% end -%>
                    <% if node['rabbitmq']['ssl_secure_renegotiate'] -%>,{secure_renegotiate, <%= node['rabbitmq']['ssl_secure_renegotiate'] %>}<% end -%>
                    <% if node['rabbitmq']['ssl_honor_cipher_order'] -%>,{honor_cipher_order, <%= node['rabbitmq']['ssl_honor_cipher_order'] %>}<% end -%>
                    <% if node['rabbitmq']['ssl_honor_ecc_order'] -%>,{honor_ecc_order, <%= node['rabbitmq']['ssl_honor_ecc_order'] %>}<% end -%>
                    ]},
<% end %>

<% if node['rabbitmq']['tcp_listen_interface'] -%>
{tcp_listeners, [{"<%= node['rabbitmq']['tcp_listen_interface'] %>", <%= node['rabbitmq']['port'] %>}]},
<% else %>
{tcp_listeners, [<%= node['rabbitmq']['port'] %>]},
<% end -%>

<% if node['rabbitmq']['tcp_listen'] -%>
    {tcp_listen_options, [binary,
                          {packet, <%= node['rabbitmq']['tcp_listen_packet'] %>},
                          {reuseaddr, <%= node['rabbitmq']['tcp_listen_reuseaddr'] %>},
                          {backlog, <%= node['rabbitmq']['tcp_listen_backlog'] %>},
                          {nodelay, <%= node['rabbitmq']['tcp_listen_nodelay'] %>},
                          {exit_on_close, <%= node['rabbitmq']['tcp_listen_exit_on_close'] %>},
                          {keepalive, <%= node['rabbitmq']['tcp_listen_keepalive'] %>},

                          <% if node['rabbitmq']['tcp_listen_buffer'] -%>
                          {buffer, <%= node['rabbitmq']['tcp_listen_buffer'] %>},
                          <% end -%>

                          <% if node['rabbitmq']['tcp_listen_sndbuf'] -%>
                          {sndbuf, <%= node['rabbitmq']['tcp_listen_sndbuf'] %>},
                          <% end -%>

                          <% if node['rabbitmq']['tcp_listen_recbuf'] -%>
                          {recbuf, <%= node['rabbitmq']['tcp_listen_recbuf'] %>},
                          <% end -%>

                          {linger, {<%= node['rabbitmq']['tcp_listen_linger'] %>,<%= node['rabbitmq']['tcp_listen_linger_timeout'] %>}}]},
<% else -%>
   {tcp_listen_options, [binary]},
<% end %>

<% if node['rabbitmq']['log_levels'] -%>
    {log_levels, [<%= node['rabbitmq']['log_levels'].map{ |key, value| "{ #{key}, #{value} }"}.join(', ') %>]},
<% end %>
<% if node['rabbitmq']['disk_free_limit_relative'] -%>
    {disk_free_limit, {mem_relative, <%= node['rabbitmq']['disk_free_limit_relative'] %>}},
<% end %>
<% if node['rabbitmq']['disk_free_limit'] %>
    <% if node['rabbitmq']['disk_free_limit'].is_a? String %>
    {disk_free_limit, "<%= node['rabbitmq']['disk_free_limit'] %>"},
    <%elsif node['rabbitmq']['disk_free_limit'].is_a? Integer %>
    {disk_free_limit, <%= node['rabbitmq']['disk_free_limit'] %>},
    <% end %>
<% end %>
<% if node['rabbitmq']['vm_memory_high_watermark'] -%>
    {vm_memory_high_watermark, <%= node['rabbitmq']['vm_memory_high_watermark'] %>},
<% end %>
<% if node['rabbitmq']['channel_max'] -%>
    {channel_max, <%= node['rabbitmq']['channel_max'] %>},
<% end %>
<% if node['rabbitmq']['loopback_users'] -%>
    {loopback_users, [<%= node['rabbitmq']['loopback_users'].map{|n| "<<\"#{n}\">>"}.join(',') %>]},
<% end %>

    {default_user, <<"<%= node['rabbitmq']['default_user'] %>">>},
    {default_pass, <<"<%= node['rabbitmq']['default_pass'] %>">>},
    {heartbeat, <%= node['rabbitmq']['heartbeat'] %>}

<% if node['rabbitmq']['credit_flow_defaults'] -%>
    {credit_flow_default_credit, {<%= node['rabbitmq']['credit_flow_defaults']['initial'] %>, <%= node['rabbitmq']['credit_flow_defaults']['more_credit_after'] %>}},
<% end %>

    <% node['rabbitmq']['additional_rabbit_configs'].each do |key,value|  -%>
      ,{<%= key %>, <%= value %>}
    <% end -%>
  ]}
<%if node['rabbitmq']['ldap']['enabled']%>
    ,{rabbitmq_auth_backend_ldap, [
        <% node['rabbitmq']['ldap']['conf'].each_with_index do |(key, value), index|  -%>
            <%if index == 0%>
                {<%= key %>, <%= value %>}
            <%else%> 
	            ,{<%= key %>, <%= value %>}
            <%end%>
        <% end -%>
    ]}
<% end %>
<% node['rabbitmq']['conf'].each do |key,value|  -%>
	,{<%= key %>, <%= value %>}
<% end -%>
].
